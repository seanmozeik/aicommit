# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# .aic - AICommit Release Configuration
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
#
# This file configures the `aic release` command.
#
# SECTIONS:
#   [release]  - Commands run BEFORE commit/tag (build, test, package)
#   [publish]  - Commands run AFTER push (npm publish, GitHub release, etc.)
#
# SYNTAX:
#   - Lines starting with # are comments
#   - Empty lines are ignored
#   - Commands run sequentially; if one fails, release aborts
#   - Multi-line commands: end lines with \ to continue
#   - All shell features work: pipes, redirects, &&, ||, $(), etc.
#
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[release]
# ─────────────────────────────────────────────────────────────────────────────
# Build & Test Phase
# These commands run after version bump, before changelog generation.
# ─────────────────────────────────────────────────────────────────────────────

# Clean previous build artifacts
rm -rf dist

# Run tests (uncomment as needed)
# bun test
# npm test
# cargo test
# go test ./...
# pytest

# Run linter (uncomment as needed)
# bun run lint
# npm run lint
# cargo clippy

# Build the project
bun run build

# ─────────────────────────────────────────────────────────────────────────────
# Packaging Phase
# Create distributable archives for different platforms.
# ─────────────────────────────────────────────────────────────────────────────

# Example: Cross-platform binary builds with Bun
# bun build ./src/index.ts --compile --target=bun-darwin-arm64 --outfile dist/myapp-darwin-arm64 --minify
# bun build ./src/index.ts --compile --target=bun-darwin-x64 --outfile dist/myapp-darwin-x64 --minify
# bun build ./src/index.ts --compile --target=bun-linux-x64 --outfile dist/myapp-linux-x64 --minify

# Example: Create tar.gz archives
# cd dist && for f in myapp-*; do [ -f "$f" ] && tar -czvf "${f}.tar.gz" "$f" && rm "$f"; done

# Example: Generate checksums with Bun
# bun -e "import{readdir}from'fs/promises';for(const f of(await readdir('dist')).filter(f=>f.endsWith('.tar.gz'))){console.log(new Bun.CryptoHasher('sha256').update(await Bun.file('dist/'+f).arrayBuffer()).digest('hex')+'  '+f)}" > dist/checksums.txt

[publish]
# ─────────────────────────────────────────────────────────────────────────────
# Publish Phase
# These commands run after successful push (with tags).
# ─────────────────────────────────────────────────────────────────────────────

# Example: Create GitHub release with binaries
# awk '/^## \[/{count++} count==1' CHANGELOG.md | tail -n +2 > /tmp/release-notes.md
# gh release create "v$(bun -p "require('./package.json').version")" \
#   dist/*.tar.gz \
#   dist/checksums.txt \
#   --title "v$(bun -p "require('./package.json').version")" \
#   --notes-file /tmp/release-notes.md

# Example: Publish to npm
# npm publish

# Example: Publish to PyPI
# twine upload dist/*

# Example: Publish to crates.io
# cargo publish

# Example: Update Homebrew formula (multi-line command with \)
# VERSION=$(bun -p "require('./package.json').version") && \
# SHA=$(shasum -a 256 dist/myapp-darwin-arm64.tar.gz | cut -d' ' -f1) && \
# sed -i '' "s/version \".*\"/version \"$VERSION\"/" Formula/myapp.rb && \
# sed -i '' "s/sha256 \".*\"/sha256 \"$SHA\"/" Formula/myapp.rb

# Example: Copy formula to tap and push
# cp Formula/myapp.rb ~/workspace/tap/Formula/ && \
# cd ~/workspace/tap && \
# git add -A && \
# git commit -m "myapp $(bun -p "require('$OLDPWD/package.json').version")" && \
# git push

# Example: Deploy to server
# rsync -avz dist/ user@server:/var/www/releases/

# Example: Notify Slack
# curl -X POST -H 'Content-type: application/json' \
#   --data "{\"text\":\"Released v$(bun -p "require('./package.json').version")\"}" \
#   $SLACK_WEBHOOK_URL

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# TIPS:
#
# 1. Get version in scripts:
#    - Node/Bun: bun -p "require('./package.json').version"
#    - Python:   python -c "import tomllib; print(tomllib.load(open('pyproject.toml','rb'))['project']['version'])"
#    - Rust:     cargo pkgid | cut -d# -f2
#    - Go:       git describe --tags --abbrev=0
#
# 2. Conditional execution:
#    - Run only if file exists: [ -f "dist/app" ] && tar -czf app.tar.gz dist/app
#    - Run only on success:     npm test && npm run build
#    - Continue on failure:     npm run optional-step || true
#
# 3. Environment variables:
#    - All env vars from your shell are available
#    - Use $HOME, $USER, $PWD, etc.
#    - Export secrets via: export MY_TOKEN=xxx before running aic release
#
# 4. Working directory:
#    - Commands run from git repository root
#    - Use cd for temporary directory changes within a command
#
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
